<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ù…Ø© (Admin)</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard-redesign.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-header {
            background: #1f2937;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-container {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f3f4f6;
            font-weight: 700;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .badge-admin {
            background: #4b5563;
            color: white;
        }

        .badge-provider {
            background: #3b82f6;
            color: white;
        }

        .badge-customer {
            background: #10b981;
            color: white;
        }

        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-delete {
            background: #fee2e2;
            color: #b91c1c;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #111827;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="admin-header">
        <h2>ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ (OP Admin)</h2>
        <button onclick="logout()" class="btn btn-ghost" style="color:white; border-color:white;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="admin-container">
        <!-- Users Management -->
        <h3 class="section-title">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø¯ÙˆØ± (Role)</th>
                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="usersTable">
                <tr>
                    <td colspan="5">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                </tr>
            </tbody>
        </table>

        <!-- Bookings Management -->
        <h3 class="section-title">ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="bookingsTable">
                <tr>
                    <td colspan="6">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        const SUPABASE_URL = 'https://rkhkvmcnjuwoxammhsqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJraGt2bWNuanV3b3hhbW1oc3FuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODk0MjcsImV4cCI6MjA4NTk2NTQyN30.iGTVKa7iap8MLZ8v0efCvzsqzviNBbacVfEDxQGDsZQ';
        const searchParams = new URLSearchParams(window.location.search);

        // Simple security check (in real app, use RLS)
        // This is a client-side dashboard, essentially a "God Mode" viewer
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            // Check if user is admin (using the special column we will add)
            const { data: profile } = await supabase.from('profiles').select('is_admin').eq('id', session.user.id).single();
            if (!profile?.is_admin) {
                alert('â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†!');
                window.location.href = 'index.html';
                return;
            }

            loadUsers();
            loadBookings();
        }

        async function loadUsers() {
            const { data: users } = await supabase.from('profiles').select('*').order('created_at', { ascending: false });
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id.slice(0, 8)}...</td>
                    <td>${u.full_name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</td>
                    <td><span class="badge badge-${u.role}">${u.role}</span> ${u.is_admin ? 'ğŸ‘‘' : ''}</td>
                    <td>${u.phone || '-'}</td>
                    <td>
                        
                    </td>
                </tr>
            `).join('');
        }

        async function loadBookings() {
            const { data: bookings } = await supabase.from('bookings').select('*, providers(name)').order('created_at', { ascending: false });
            const tbody = document.getElementById('bookingsTable');
            tbody.innerHTML = bookings.map(b => `
                <tr>
                    <td>${b.id.slice(0, 8)}</td>
                    <td>${b.customer_name}</td>
                    <td>${b.providers?.name}</td>
                    <td>${b.status}</td>
                    <td>${new Date(b.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="action-btn btn-delete" onclick="deleteBooking('${b.id}')">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteBooking(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
            const { error } = await supabase.from('bookings').delete().eq('id', id);
            if (error) alert('Ø®Ø·Ø£: ' + error.message);
            else loadBookings();
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        init();
    </script>
</body>

</html>