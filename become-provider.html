<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© - Ø®Ø¯Ù…ØªÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="auth.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
</head>

<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="index.html" class="logo">
                    <span class="logo-icon">ğŸ› ï¸</span>
                    <span class="logo-text">Ø®Ø¯Ù…ØªÙŠ</span>
                </a>
                <h2>Ø§Ù†Ø¶Ù… ÙƒÙ…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©</h2>
                <p>Ù‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ§Ø¨Ø¯Ø£ Ø¨Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
            </div>

            <form id="upgradeForm" onsubmit="handleUpgrade(event)">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="fullName" required readonly class="readonly-input">
                </div>

                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <div class="phone-input-wrapper">
                        <input type="tel" id="phone" placeholder="790000000" pattern="[0-9]{9}" required>
                        <span class="country-code">+962</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù‡Ù†Ø© / Ø§Ù„ØªØ®ØµØµ</label>
                    <select id="specialty" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ...</option>
                        <option value="Ø³Ø¨Ø§ÙƒØ©">Ø³Ø¨Ø§ÙƒØ©</option>
                        <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                        <option value="Ù†Ø¬Ø§Ø±Ø©">Ù†Ø¬Ø§Ø±Ø©</option>
                        <option value="ØªÙ†Ø¸ÙŠÙ">ØªÙ†Ø¸ÙŠÙ</option>
                        <option value="ØªÙƒÙŠÙŠÙ">ØªÙƒÙŠÙŠÙ</option>
                        <option value="Ø¯Ù‡Ø§Ù†">Ø¯Ù‡Ø§Ù†</option>
                        <option value="Ù†Ù‚Ù„ Ø¹ÙØ´">Ù†Ù‚Ù„ Ø¹ÙØ´</option>
                        <option value="Ø³ØªÙ„Ø§ÙŠØª">Ø³ØªÙ„Ø§ÙŠØª</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                    <select id="city" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©...</option>
                        <option value="Ø¹Ù…Ù‘Ø§Ù†">Ø¹Ù…Ù‘Ø§Ù†</option>
                        <option value="Ø§Ù„Ø²Ø±Ù‚Ø©">Ø§Ù„Ø²Ø±Ù‚Ø©</option>
                        <option value="Ø¥Ø±Ø¨Ø¯">Ø¥Ø±Ø¨Ø¯</option>
                        <option value="Ø§Ù„Ø¹Ù‚Ø¨Ø©">Ø§Ù„Ø¹Ù‚Ø¨Ø©</option>
                        <option value="Ø§Ù„Ø³Ù„Ø·">Ø§Ù„Ø³Ù„Ø·</option>
                        <option value="Ù…Ø§Ø¯Ø¨Ø§">Ù…Ø§Ø¯Ø¨Ø§</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="bio" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ø®Ø¨Ø±ØªÙƒ ÙˆØ®Ø¯Ù…Ø§ØªÙƒ..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary btn-block">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <div class="auth-footer">
                    <a href="customer-dashboard.html">ØªØ±Ø§Ø¬Ø¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Check session and load user data
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            // Get Bio/Details
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (profile) {
                document.getElementById('fullName').value = profile.full_name || '';
                if (profile.role === 'provider') {
                    alert('Ø­Ø³Ø§Ø¨Ùƒ Ù…ÙØ¹Ù„ ÙƒÙ…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© Ø¨Ø§Ù„ÙØ¹Ù„!');
                    window.location.href = 'dashboard.html';
                }
            }
        });

        async function handleUpgrade(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ù‚ÙŠØ©...';

            const phone = document.getElementById('phone').value;
            const fullPhone = '+962' + phone;
            const specialty = document.getElementById('specialty').value;
            const city = document.getElementById('city').value;
            const bio = document.getElementById('bio').value;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();

                // 1. Update Profile Role
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .update({
                        role: 'provider',
                        phone: fullPhone
                    })
                    .eq('id', session.user.id);

                if (profileError) throw profileError;

                // 2. Insert into Providers
                const { error: providerError } = await supabaseClient
                    .from('providers')
                    .insert({
                        user_id: session.user.id,
                        name: document.getElementById('fullName').value,
                        specialty: specialty,
                        city: city,
                        phone: fullPhone,
                        bio: bio,
                        location: city
                    });

                if (providerError) throw providerError;

                alert('ØªÙ… ØªØ±Ù‚ÙŠØ© Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰ Ø§Ù‡Ù„Ø§ Ø¨Ùƒ Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© ÙÙŠ Ø®Ø¯Ù…ØªÙŠ.');
                window.location.href = 'dashboard.html';

            } catch (err) {
                console.error('Upgrade error:', err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨';
            }
        }
    </script>
    <style>
        .readonly-input {
            background-color: #f8f9fa;
            cursor: not-allowed;
            color: #666;
        }
    </style>
</body>

</html>